(function(t){t.widget("ra.filteringMultiselect",{_cache:{},options:{createQuery:function(t){return{query:t}},sortable:!1,regional:{up:"Up",down:"Down",add:"Add",chooseAll:"Choose all",chosen:"Chosen records",clearAll:"Clear all",remove:"Remove",selectChoice:"Select your choice(s) and click"},searchDelay:400,remote_source:null,xhr:!1},_create:function(){this._cache={},this._build(),this._buildCache(),this._bindEvents()},_build:function(){var e;this.wrapper=t('<div class="ra-multiselect">'),this.wrapper.insertAfter(this.element),this.header=t('<div class="ra-multiselect-header ui-helper-clearfix">'),this.filter=t('<input type="search" placeholder="'+this.options.regional.search+'" class="ra-multiselect-search"/>'),this.header.append(this.filter),this.wrapper.append(this.header),this.columns={left:t('<div class="ra-multiselect-column ra-multiselect-left">'),center:t('<div class="ra-multiselect-column ra-multiselect-center">'),right:t('<div class="ra-multiselect-column ra-multiselect-right">')};for(e in this.columns)this.columns.hasOwnProperty(e)&&this.wrapper.append(this.columns[e]);this.collection=t('<select multiple="multiple"></select>'),this.collection.addClass("ra-multiselect-collection"),this.addAll=t('<a href="#" class="ra-multiselect-item-add-all"><span class="ui-icon ui-icon-circle-triangle-e"></span>'+this.options.regional.chooseAll+"</a>"),this.columns.left.html(this.collection).append(this.addAll),this.collection.wrap('<div class="wrapper"/>'),this.add=t('<a href="#" class="ui-icon ui-icon-circle-triangle-e ra-multiselect-item-add">'+this.options.regional.add+"</a>"),this.remove=t('<a href="#" class="ui-icon ui-icon-circle-triangle-w ra-multiselect-item-remove">'+this.options.regional.remove+"</a>"),this.columns.center.append(this.add).append(this.remove),this.options.sortable&&(this.up=t('<a href="#" class="ui-icon ui-icon-circle-triangle-n ra-multiselect-item-up">'+this.options.regional.up+"</a>"),this.down=t('<a href="#" class="ui-icon ui-icon-circle-triangle-s ra-multiselect-item-down">'+this.options.regional.down+"</a>"),this.columns.center.append(this.up).append(this.down)),this.selection=t('<select class="ra-multiselect-selection" multiple="multiple"></select>'),this.removeAll=t('<a href="#" class="ra-multiselect-item-remove-all"><span class="ui-icon ui-icon-circle-triangle-w"></span>'+this.options.regional.clearAll+"</a>"),this.columns.right.append(this.selection).append(this.removeAll),this.selection.wrap('<div class="wrapper"/>'),this.element.css({display:"none"})},_bindEvents:function(){var e=this;this.addAll.click(function(n){e._select(t("option",e.collection)),n.preventDefault(),e.selection.trigger("change")}),this.add.click(function(n){e._select(t(":selected",e.collection)),n.preventDefault(),e.selection.trigger("change")}),this.removeAll.click(function(n){e._deSelect(t("option",e.selection)),n.preventDefault(),e.selection.trigger("change")}),this.remove.click(function(n){e._deSelect(t(":selected",e.selection)),n.preventDefault(),e.selection.trigger("change")});var n=null;this.options.sortable&&(this.up.click(function(n){e._move("up",t(":selected",e.selection)),n.preventDefault()}),this.down.click(function(n){e._move("down",t(":selected",e.selection)),n.preventDefault()})),this.filter.bind("keyup click",function(){n&&clearTimeout(n),n=setTimeout(function(){e._queryFilter(e.filter.val())},e.options.searchDelay)})},_queryFilter:function(t){var e=this;e._query(t,function(t){var n,i="";for(n in t)t.hasOwnProperty(n)&&!e.selected(t[n].id)&&(i+='<option value="'+t[n].id+'" title="'+t[n].label+'">'+t[n].label+"</option>");e.collection.html(i)})},_buildCache:function(){var e=this;this.element.find("option").each(function(n,i){i.selected?(e._cache[i.value]=i.innerHTML,t(i).clone().appendTo(e.selection).attr("selected",!1).attr("title",t(i).text())):(e._cache[i.value]=i.innerHTML,t(i).clone().appendTo(e.collection).attr("selected",!1).attr("title",t(i).text()))})},_deSelect:function(e){var n=this;e.each(function(t,e){n.element.find('option[value="'+e.value+'"]').removeAttr("selected")}),t(e).appendTo(this.collection).attr("selected",!1)},_query:function(e,n){var i,o=[];if(""===e){if(!this.options.xhr)for(i in this._cache)this._cache.hasOwnProperty(i)&&o.push({id:i,label:this._cache[i]});n.apply(this,[o])}else if(this.options.xhr)t.ajax({beforeSend:function(t){t.setRequestHeader("Accept","application/json")},url:this.options.remote_source,data:this.options.createQuery(e),success:n});else{e=new RegExp(e+".*","i");for(i in this._cache)this._cache.hasOwnProperty(i)&&e.test(this._cache[i])&&o.push({id:i,label:this._cache[i]});n.apply(this,[o])}},_select:function(e){var n=this;e.each(function(e,i){var o=n.element.find('option[value="'+i.value+'"]');o.length?o.attr("selected","selected"):n.element.append(t('<option value="'+i.value+'" selected="selected"></option>'))}),t(e).appendTo(this.selection).attr("selected",!1)},_move:function(e,n){var i=this;"up"==e?n.each(function(e,n){var o=t(n).prev();if(o.length>0){var r=i.element.find('option[value="'+n.value+'"]'),s=i.element.find('option[value="'+o[0].value+'"]');s.before(r),o.before(t(n))}}):(t.fn.reverse=[].reverse,n.reverse().each(function(e,n){var o=t(n).next();if(o.length>0){var r=i.element.find('option[value="'+n.value+'"]'),s=i.element.find('option[value="'+o[0].value+'"]');s.after(r),o.after(t(n))}}))},selected:function(t){return this.element.find('option[value="'+t+'"]').attr("selected")},destroy:function(){this.wrapper.remove(),this.element.css({display:"inline"}),t.Widget.prototype.destroy.apply(this,arguments)}})})(jQuery);