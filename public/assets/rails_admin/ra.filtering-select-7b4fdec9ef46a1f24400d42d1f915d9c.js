(function(t){t.widget("ra.filteringSelect",{options:{createQuery:function(t){return{query:t}},minLength:0,searchDelay:200,remote_source:null,source:null,xhr:!1},_create:function(){var e=this,n=this.element.hide(),i=n.children(":selected"),o=i.val()?i.text():"";this.options.source=this.options.xhr?this.options.remote_source:n.children("option").map(function(){return{label:t(this).text(),value:this.value}}).toArray();var r=t('<div class="input-append filtering-select" style="float:left"></div>'),s=this.input=t('<input type="text">').val(o).addClass("ra-filtering-select-input").attr("style",n.attr("style")).show().autocomplete({delay:this.options.searchDelay,minLength:this.options.minLength,source:this._getSourceFunction(this.options.source),select:function(i,o){var r=t('<option value="'+o.item.id+'" selected="selected">'+o.item.value+"</option>");n.html(r),n.trigger("change",o.item.id),e._trigger("selected",i,{item:r}),t(e.element.parents(".controls")[0]).find(".update").removeClass("disabled")},change:function(i,o){if(!o.item){var r=new RegExp("^"+t.ui.autocomplete.escapeRegex(t(this).val())+"$","i"),a=!1;if(n.children("option").each(function(){return t(this).text().match(r)?(this.selected=a=!0,!1):void 0}),!a||""==t(this).val())return t(this).val(null),n.html(t('<option value="" selected="selected"></option>')),s.data("autocomplete").term="",t(e.element.parents(".controls")[0]).find(".update").addClass("disabled"),!1}}}).keyup(function(){0==t(this).val().length&&(n.html(t('<option value="" selected="selected"></option>')),n.trigger("change"))});n.attr("placeholder")&&s.attr("placeholder",n.attr("placeholder")),s.data("autocomplete")._renderItem=function(e,n){return t("<li></li>").data("item.autocomplete",n).append(t("<a></a>").html(n.label||n.id)).appendTo(e)};var a=this.button=t('<label class="add-on ui-button ui-widget ui-state-default ui-corner-all ui-button-icon-only" title="Show All Items" role="button"><span class="ui-button-icon-primary ui-icon ui-icon-triangle-1-s"></span><span class="ui-button-text">&nbsp;</span></label>').click(function(){return s.autocomplete("widget").is(":visible")?(s.autocomplete("close"),void 0):(s.autocomplete("search",""),s.focus(),void 0)});r.append(s).append(a).insertAfter(n)},_getResultSet:function(e,n,i){var o=new RegExp(t.ui.autocomplete.escapeRegex(e.term),"i");return t.map(n,function(n){return(n.id||n.value)&&(i||o.test(n.label))?{label:n.label?n.label.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t.ui.autocomplete.escapeRegex(e.term)+")(?![^<>]*>)(?![^&;]+;)","gi"),"<strong>$1</strong>"):n.id,value:n.label||n.id,id:n.id||n.value}:void 0})},_getSourceFunction:function(e){var n=this,i=0;return t.isArray(e)?function(t,i){i(n._getResultSet(t,e,!1))}:"string"==typeof e?function(o,r){this.xhr&&this.xhr.abort(),this.xhr=t.ajax({url:e,data:n.options.createQuery(o.term),dataType:"json",autocompleteRequest:++i,success:function(t){this.autocompleteRequest===i&&r(n._getResultSet(o,t,!0))},error:function(){this.autocompleteRequest===i&&r([])}})}:e},destroy:function(){this.input.remove(),this.button.remove(),this.element.show(),t.Widget.prototype.destroy.call(this)}})})(jQuery);