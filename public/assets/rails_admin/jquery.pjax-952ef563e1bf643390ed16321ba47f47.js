// copyright chris wanstrath
(function(t){function e(e,i,o){var r=this;return this.on("click.pjax",e,function(e){var s=t.extend({},p(i,o));s.container||(s.container=t(this).attr("data-pjax")||r),n(e,s)})}function n(e,n,i){i=p(n,i);var r=e.currentTarget;if("A"!==r.tagName.toUpperCase())throw"$.fn.pjax or $.pjax.click requires an anchor element";if(!(e.which>1||e.metaKey||e.ctrlKey||e.shiftKey||e.altKey||location.protocol!==r.protocol||location.host!==r.host||r.hash&&r.href.replace(r.hash,"")===location.href.replace(location.hash,"")||r.href===location.href+"#")){var s={url:r.href,container:t(r).attr("data-pjax"),target:r,fragment:null};o(t.extend({},s,i)),e.preventDefault()}}function i(e,n,i){i=p(n,i);var r=e.currentTarget;if("FORM"!==r.tagName.toUpperCase())throw"$.pjax.submit requires a form element";var s={type:r.method,url:r.action,data:t(r).serializeArray(),container:t(r).attr("data-pjax"),target:r,fragment:null};o(t.extend({},s,i)),e.preventDefault()}function o(e){function n(e,n){var o=t.Event(e,{relatedTarget:i});return a.trigger(o,n),!o.isDefaultPrevented()}e=t.extend(!0,{},t.ajaxSettings,o.defaults,e),t.isFunction(e.url)&&(e.url=e.url());var i=e.target,r=h(e.url).hash,a=e.context=d(e.container);e.data||(e.data={}),e.data._pjax=a.selector;var l;e.beforeSend=function(t,i){return"GET"!==i.type&&(i.timeout=0),t.setRequestHeader("X-PJAX","true"),t.setRequestHeader("X-PJAX-Container",a.selector),n("pjax:beforeSend",[t,i])?(i.timeout>0&&(l=setTimeout(function(){n("pjax:timeout",[t,e])&&t.abort("timeout")},i.timeout),i.timeout=0),e.requestUrl=h(i.url).href,void 0):!1},e.complete=function(t,i){l&&clearTimeout(l),n("pjax:complete",[t,i,e]),n("pjax:end",[t,e])},e.error=function(t,i,o){var r=m("",t,e),a=n("pjax:error",[t,i,o,e]);"GET"==e.type&&"abort"!==i&&a&&s(r.url)},e.success=function(i,l,u){var p=m(i,u,e);if(!p.contents)return s(p.url),void 0;if(o.state={id:e.id||c(),url:p.url,title:p.title,container:a.selector,fragment:e.fragment,timeout:e.timeout},(e.push||e.replace)&&window.history.replaceState(o.state,p.title,p.url),p.title&&(document.title=p.title),a.html(p.contents),"number"==typeof e.scrollTo&&t(window).scrollTop(e.scrollTo),(e.replace||e.push)&&window._gaq&&_gaq.push(["_trackPageview"]),""!==r){var d=h(p.url);d.hash=r,o.state.url=d.href,window.history.replaceState(o.state,p.title,d.href);var f=t(d.hash);f.length&&t(window).scrollTop(f.offset().top)}n("pjax:success",[i,l,u,e])},o.state||(o.state={id:c(),url:window.location.href,title:document.title,container:a.selector,fragment:e.fragment,timeout:e.timeout},window.history.replaceState(o.state,document.title));var p=o.xhr;p&&4>p.readyState&&(p.onreadystatechange=t.noop,p.abort()),o.options=e;var p=o.xhr=t.ajax(e);return p.readyState>0&&(e.push&&!e.replace&&(g(o.state.id,a.clone().contents()),window.history.pushState(null,"",u(e.requestUrl))),n("pjax:start",[p,e]),n("pjax:send",[p,e])),o.xhr}function r(e,n){var i={url:window.location.href,push:!1,replace:!0,scrollTo:!1};return o(t.extend(i,p(e,n)))}function s(t){window.history.replaceState(null,"","#"),window.location.replace(t)}function a(e){var n=e.state;if(n&&n.container){var i=t(n.container);if(i.length){var r=w[n.id];if(!o.state)return o.state=n,void 0;var a=o.state.id<n.id?"forward":"back";v(a,o.state.id,i.clone().contents());var l=t.Event("pjax:popstate",{state:n,direction:a});i.trigger(l);var c={id:n.id,url:n.url,container:i,push:!1,fragment:n.fragment,timeout:n.timeout,scrollTo:!1};r?(i.trigger("pjax:start",[null,c]),n.title&&(document.title=n.title),i.html(r),o.state=n,i.trigger("pjax:end",[null,c])):o(c),i[0].offsetHeight}else s(location.href)}}function l(e){var n=t.isFunction(e.url)?e.url():e.url,i=e.type?e.type.toUpperCase():"GET",o=t("<form>",{method:"GET"===i?"GET":"POST",action:n,style:"display:none"});"GET"!==i&&"POST"!==i&&o.append(t("<input>",{type:"hidden",name:"_method",value:i.toLowerCase()}));var r=e.data;if("string"==typeof r)t.each(r.split("&"),function(e,n){var i=n.split("=");o.append(t("<input>",{type:"hidden",name:i[0],value:i[1]}))});else if("object"==typeof r)for(key in r)o.append(t("<input>",{type:"hidden",name:key,value:r[key]}));t(document.body).append(o),o.submit()}function c(){return(new Date).getTime()}function u(t){return t.replace(/\?_pjax=[^&]+&?/,"?").replace(/_pjax=[^&]+&?/,"").replace(/[\?&]$/,"")}function h(t){var e=document.createElement("a");return e.href=t,e}function p(e,n){return e&&n?n.container=e:n=t.isPlainObject(e)?e:{container:e},n.container&&(n.container=d(n.container)),n}function d(e){if(e=t(e),e.length){if(""!==e.selector&&e.context===document)return e;if(e.attr("id"))return t("#"+e.attr("id"));throw"cant get selector for pjax container!"}throw"no pjax container for "+e.selector}function f(t,e){return t.filter(e).add(t.find(e))}function m(e,n,i){var o={};if(o.url=u(n.getResponseHeader("X-PJAX-URL")||i.requestUrl),/<html/i.test(e))var r=t(e.match(/<head[^>]*>([\s\S.]*)<\/head>/i)[0]),s=t(e.match(/<body[^>]*>([\s\S.]*)<\/body>/i)[0]);else var r=s=t(e);if(0===s.length)return o;if(o.title=f(r,"title").last().text(),i.fragment){if("body"===i.fragment)var a=s;else var a=f(s,i.fragment).first();a.length&&(o.contents=a.contents(),o.title||(o.title=a.attr("title")||a.data("title")))}else/<html/i.test(e)||(o.contents=s);return o.contents&&(o.contents=o.contents.not("title"),o.contents.find("title").remove()),o.title&&(o.title=t.trim(o.title)),o}function g(t,e){for(w[t]=e,k.push(t);x.length;)delete w[x.shift()];for(;k.length>o.defaults.maxCacheLength;)delete w[k.shift()]}function v(t,e,n){var i,o;w[e]=n,"forward"===t?(i=k,o=x):(i=x,o=k),i.push(e),(e=o.pop())&&delete w[e]}function y(){t.fn.pjax=e,t.pjax=o,t.pjax.enable=t.noop,t.pjax.disable=b,t.pjax.click=n,t.pjax.submit=i,t.pjax.reload=r,t.pjax.defaults={timeout:650,push:!0,replace:!1,type:"GET",dataType:"html",scrollTo:0,maxCacheLength:20},t(window).bind("popstate.pjax",a)}function b(){t.fn.pjax=function(){return this},t.pjax=l,t.pjax.enable=y,t.pjax.disable=t.noop,t.pjax.click=t.noop,t.pjax.submit=t.noop,t.pjax.reload=function(){window.location.reload()},t(window).unbind("popstate.pjax",a)}var w={},x=[],k=[];0>t.inArray("state",t.event.props)&&t.event.props.push("state"),t.support.pjax=window.history&&window.history.pushState&&window.history.replaceState&&!navigator.userAgent.match(/((iPod|iPhone|iPad).+\bOS\s+[1-4]|WebApps\/.+CFNetwork)/),t.support.pjax?y():b()})(jQuery);